<?xml version="1.0" encoding="UTF-8"?>
<project name="com.ibm.watson.safari.update" default="build.update.zip" basedir=".">
	<import file="../org.eclipse.safari.feature/buildCommon.xml"/>

	<property name="update.name"        value="org.eclipse.safari.update"/>
	<property name="update.version"     value="${safari.version}"/>
	<property name="update.temp.folder" value="${basedir}/update.temp.folder"/>
	<property name="update.destination" value="${basedir}"/>
	<property name="update.server"      value="orquesta.watson.ibm.com"/>
	<property name="update.server.dir"  value="/usr/src/safari"/>
	<property name="zip.file"           value="${update.destination}/${update.name}_${update.version}.zip"/>

	<target name="deploy.zip" description="Copies the update archive to the update server.">
		<echo message="Copying update zip file to update server ${update.server}"/>
		<scp file="${zip.file}" keyfile="${user.home}/.ssh/id_dsa" passphrase="" todir="${user.name}@${update.server}:${update.server.dir}"></scp>
	</target>

	<target name="build.update.zip">
		<delete dir="${update.temp.folder}"/>
		<mkdir dir="${update.temp.folder}"/>
		<antcall target="export.features"/>
		<antcall target="copy.feature">
			<param name="feature.name"    value="org.eclipse.safari.runtime"/>
			<param name="feature.version" value="${update.version}"/>
			<param name="feature.dir"     value="../org.eclipse.safari.runtime.feature"/>
		</antcall>
		<antcall target="copy.feature">
			<param name="feature.name"    value="org.eclipse.safari.jikespg"/>
			<param name="feature.version" value="${update.version}"/>
			<param name="feature.dir"     value="../org.eclipse.safari.jikespg.feature"/>
		</antcall>
		<antcall target="copy.feature">
			<param name="feature.name"    value="com.ibm.watson.safari"/>
			<param name="feature.version" value="${update.version}"/>
			<param name="feature.dir"     value="../org.eclipse.safari.feature"/>
		</antcall>
		<antcall target="copy.feature">
			<param name="feature.name"    value="org.eclipse.safari.x10dt"/>
			<param name="feature.version" value="${update.version}"/>
			<param name="feature.dir"     value="../org.eclipse.safari.x10dt.feature"/>
		</antcall>
		<zip destfile="${zip.file}" basedir="${update.temp.folder}" filesonly="false" whenempty="skip" update="false"/>
		<delete dir="${update.temp.folder}"/>
	</target>

	<target name="copy.feature">
		<echo message="Feature directory is ${feature.dir}"/>

		<mkdir dir="${update.temp.folder}/features"/>
		<copy todir="${update.temp.folder}/features" failonerror="true" overwrite="false">
			<fileset dir="${feature.dir}" includes="${feature.name}_${feature.version}.jar"/>
		</copy>

		<mkdir dir="${update.temp.folder}/plugins"/>
		<copy todir="${update.temp.folder}/plugins" failonerror="true" overwrite="false">
			<fileset dir="${feature.dir}/plugins" includes="*.jar"/>
		</copy>

		<copy file="site.xml" todir="${update.temp.folder}" failonerror="true" overwrite="false"/>
		<copy file="index.html" todir="${update.temp.folder}" failonerror="true" overwrite="false"/>

		<mkdir dir="${update.temp.folder}/web"/>
		<copy todir="${update.temp.folder}/web" failonerror="true" overwrite="false">
			<fileset dir="${basedir}/web" includes="site.css"/>
			<fileset dir="${basedir}/web" includes="site.xsl"/>
		</copy>
	</target>

	<target name="export.features">
		<echo message="Building feature jars..."/>
		<ant antfile="../org.eclipse.safari.runtime.feature/exportFeature.xml" target="build.feature.jar" dir="../org.eclipse.safari.runtime.feature"/>
		<ant antfile="../org.eclipse.safari.jikespg.feature/exportFeature.xml" target="build.feature.jar" dir="../org.eclipse.safari.jikespg.feature"/>
		<ant antfile="../org.eclipse.safari.x10dt.feature/exportFeature.xml" target="build.feature.jar" dir="../org.eclipse.safari.x10dt.feature"/>
		<ant antfile="../org.eclipse.safari.feature/exportFeature.xml" target="build.feature.jar" dir="../org.eclipse.safari.feature"/>
		<echo message="Done building feature jar."/>
	</target>
</project>
